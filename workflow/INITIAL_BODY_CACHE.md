# 初始身体特征缓存创建指南

## 📋 概述

由于视频中的人物大多是侧脸/背影，无法通过人脸识别。为了解决这个问题，我们采用以下策略：

1. **从第一个视频提取背影特征**：从 `419.mp4` 中提取人物背影的身体特征
2. **创建初始缓存**：将这些特征作为家人的初始 `current_body_embedding` 缓存
3. **后续匹配**：后续视频中的人物背影可以通过身体特征匹配识别为家人

## 🎯 工作原理

```
第一个视频 (419.mp4)
  ↓ [YOLO检测]
检测到2个人物
  ↓ [ReID提取]
提取2个身体特征向量 (2048维)
  ↓ [保存到数据库]
更新 persons 表的 current_body_embedding
  ↓
后续视频
  ↓ [身体特征匹配]
匹配成功 → 识别为家人 ✅
```

## 🚀 使用方法

### 完整流程

```bash
# 1. 激活环境
source venv/bin/activate
source setup_env.sh

# 2. 清空数据库（可选，用于重新测试）
python workflow/clear_database.py

# 3. Phase 0: 加载家人人脸底库
python workflow/test_phase0.py

# 4. 创建初始身体特征缓存（重要！）
python workflow/create_initial_body_cache.py

# 5. Phase 1: 测试身体特征匹配
python workflow/phase1_cv_scanning/test_phase1.py
```

### 脚本功能

`create_initial_body_cache.py` 会：

1. **加载第一个视频** (`419.mp4`)
2. **检测人物**：使用 YOLO 检测画面中的人物
3. **提取身体特征**：使用 ReID 模型（OSNet）提取身体特征向量
4. **保存到数据库**：为每个家人（role='owner'）分配一个身体特征缓存

## 📊 输出示例

```
============================================================
创建初始身体特征缓存
============================================================

策略:
1. 从第一个视频（419.mp4）提取人物背影
2. 将这些背影特征作为家人的初始身体特征缓存
3. 后续视频可以通过身体特征匹配识别家人

============================================================
从第一个视频提取人物背影特征
============================================================
📹 处理第一个视频: 419.mp4
   路径: /path/to/419.mp4
   时间: 2025-09-01 07:07:05
   摄像头: doorbell
   提取了 27 帧

处理第 1 帧...
   检测到 2 个人物
   人物 1: 身体特征维度 (2048,), 人脸特征: 无（背影）
   人物 2: 身体特征维度 (2048,), 人脸特征: 无（背影）

✅ 总共提取了 2 个身体特征

============================================================
保存身体特征到数据库
============================================================
📋 找到 2 个家人记录
   ✅ Family_1 (ID: 1): 已保存身体特征缓存
      特征维度: (2048,), 帧: 0, 人物: 0
   ✅ Family_2 (ID: 2): 已保存身体特征缓存
      特征维度: (2048,), 帧: 0, 人物: 1

✅ 成功保存 2 个身体特征缓存
```

## ⚙️ 配置说明

### 提取策略

脚本会：
- 处理前 3 帧（通常足够）
- 提取所有检测到的人物的身体特征
- 按顺序分配给家人（如果身体特征数量少于家人数量，只保存前几个）

### 匹配阈值

在 `identity_arbiter.py` 中：
- `body_threshold = 0.6` - 身体匹配阈值（余弦相似度）

如果匹配失败，可以尝试：
- 降低阈值到 `0.5`（更宽松）
- 延长时间窗口到 `48小时`（如果视频时间跨度大）

## 🔍 验证缓存

运行脚本后，可以检查数据库：

```sql
SELECT id, name, role, 
       current_body_embedding IS NOT NULL as has_cache,
       body_update_time
FROM persons
WHERE role = 'owner';
```

应该看到所有家人都有 `has_cache = true`。

## 🐛 故障排除

### 问题 1: 没有检测到人物

**可能原因**:
- 视频质量问题
- YOLO 检测阈值过高

**解决方案**:
- 检查视频文件是否存在
- 降低 YOLO 检测阈值（在 `yolo_detector.py` 中）

### 问题 2: 身体特征提取失败

**可能原因**:
- ReID 模型未加载
- 图像尺寸太小

**解决方案**:
- 确保已安装 torchreid: `pip install torchreid`
- 检查日志中的错误信息

### 问题 3: 后续视频仍然匹配失败

**可能原因**:
- 身体特征差异太大（换了衣服）
- 匹配阈值过高
- 时间窗口太短

**解决方案**:
- 降低 `body_threshold` 到 `0.5`
- 延长时间窗口到 `48小时`
- 检查日志中的相似度分数

## 💡 最佳实践

1. **确保 Phase 0 已运行**：必须有家人记录才能保存缓存
2. **使用第一个视频**：通常第一个视频中的人物是家人
3. **检查日志**：查看提取了多少个身体特征
4. **验证数据库**：确认缓存已保存
5. **调整阈值**：根据实际情况调整匹配阈值

## 📚 相关文档

- `workflow/README.md` - 工作流总览
- `workflow/REID_SETUP.md` - ReID 模型设置
- `workflow/phase1_cv_scanning/identity_arbiter.py` - 身份仲裁逻辑

