# 身份识别优化方案

## 📋 问题描述

在 Phase 1 的测试中，发现很多被识别为"陌生人"的检测，实际上可能是家人，只是因为这一帧的辨识度比较低（侧脸、背影、模糊等）导致匹配失败。这会影响后续 Phase 的判断，特别是 Phase 3 和 Phase 5 中关于是否有陌生人的判断。

## 🎯 解决方案

实施了多层次的优化方案：

### 1. Phase 1: 降低匹配阈值 + 软匹配机制

#### 降低阈值
- **face_threshold**: 从 0.6 降低到 0.55
- **body_threshold**: 从 0.6 降低到 0.55
- **时间窗口**: 从 24 小时延长到 48 小时

#### 软匹配机制
- 新增 `soft_match_threshold` (默认 0.50)
- 如果身体匹配相似度在 `soft_match_threshold` 和 `body_threshold` 之间，标记为 `suspected_family`（疑似家人）
- 疑似家人在事件级别可以进一步确认

### 2. Phase 2: 事件级别的身份一致性检查

新增 `IdentityRefiner` 模块，在事件融合后对身份进行优化：

#### 优化规则

1. **多次出现提升规则**
   - 如果疑似家人在事件中多次出现（>=3次），提升为家人
   - 如果陌生人在事件中多次出现（>=3次），且事件中有家人，标记为疑似家人

2. **上下文提升规则**
   - 如果疑似家人/陌生人与家人在同一 Clip 中出现，提升为家人
   - 基于"如果与家人同时出现，很可能是家人"的假设

3. **时间重叠规则**
   - 如果陌生人与家人在相似时间出现，且位置相近，标记为疑似家人

## 📊 数据流

```
Phase 1: 身份识别
  ├─ 人脸匹配 (threshold=0.55) → family
  ├─ 身体匹配 (threshold=0.55) → family
  ├─ 软匹配 (threshold=0.50-0.55) → suspected_family
  └─ 无匹配 → stranger

Phase 2: 事件融合 + 身份优化
  ├─ 事件融合（时间+身份规则）
  ├─ 身份一致性检查（IdentityRefiner）
  │   ├─ 多次出现提升
  │   ├─ 上下文提升
  │   └─ 时间重叠提升
  └─ 输出优化后的事件

Phase 3: LLM 生成日志
  └─ 基于优化后的身份信息生成日志
```

## 🔧 配置参数

### IdentityArbiter 参数

```python
IdentityArbiter(
    face_threshold=0.55,        # 人脸匹配阈值（降低以支持低辨识度）
    body_threshold=0.55,        # 身体匹配阈值（降低以支持侧脸/背影）
    soft_match_threshold=0.50   # 软匹配阈值
)
```

### IdentityRefiner 参数

```python
IdentityRefiner(
    time_window_seconds=300,    # 时间窗口（5分钟）
    confidence_boost=0.1       # 置信度提升值
)
```

## 📈 预期效果

1. **减少误判**：降低阈值和软匹配机制可以减少将家人误判为陌生人的情况
2. **事件级别优化**：在事件级别重新评估身份，利用上下文信息提升准确性
3. **更准确的陌生人检测**：只有真正无法匹配且多次独立出现的情况才标记为陌生人

## ⚠️ 注意事项

1. **阈值调整**：如果发现误判率仍然较高，可以进一步降低阈值，但要注意不要过度降低导致误识别
2. **性能影响**：软匹配会增加一次数据库查询，但影响较小
3. **事件级别优化**：IdentityRefiner 在事件融合后运行，不会影响 Phase 1 的性能

## 🧪 测试建议

1. 运行 Phase 1 测试，观察 `suspected_family` 的数量
2. 运行完整流程测试，观察 Phase 2 中身份优化的效果
3. 检查 Phase 3 生成的日志，确认陌生人判断是否更准确

